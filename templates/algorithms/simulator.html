{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-play-circle"></i> –°–∏–º—É–ª—è—Ç–æ—Ä: {{ algorithm.name }}</h2>
            <a href="{% url 'algorithms:detail' algorithm.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5>üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ -->
                <div id="simulator-container"></div>

                <!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ -->
                {% csrf_token %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="arraySize" class="form-label">–†–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞</label>
                    <input type="range" class="form-range" id="arraySize" min="5" max="50" value="15">
                    <div class="d-flex justify-content-between">
                        <small>5</small>
                        <small id="arraySizeValue">15</small>
                        <small>50</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="speed" class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏</label>
                    <select class="form-select" id="speed">
                        <option value="slow">–ú–µ–¥–ª–µ–Ω–Ω–æ</option>
                        <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                        <option value="fast">–ë—ã—Å—Ç—Ä–æ</option>
                    </select>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="startBtn">
                        <i class="bi bi-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                    </button>
                    <button class="btn btn-warning" id="pauseBtn" disabled>
                        <i class="bi bi-pause"></i> –ü–∞—É–∑–∞
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        <i class="bi bi-arrow-clockwise"></i> –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h6 class="text-primary" id="comparisons">0</h6>
                        <small>–°—Ä–∞–≤–Ω–µ–Ω–∏–π</small>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success" id="swaps">0</h6>
                        <small>–û–±–º–µ–Ω–æ–≤</small>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <h6 class="text-warning" id="steps">0</h6>
                        <small>–®–∞–≥–æ–≤</small>
                    </div>
                    <div class="col-6">
                        <h6 class="text-info" id="time">0</h6>
                        <small>–í—Ä–µ–º—è (–º—Å)</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb"></i> –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">üéØ <strong>–ù–∞—Å—Ç—Ä–æ–π —Ä–∞–∑–º–µ—Ä</strong> –º–∞—Å—Å–∏–≤–∞ (5-50 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)</li>
                    <li class="mb-2">‚ö° <strong>–í—ã–±–µ—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç—å</strong> –∞–Ω–∏–º–∞—Ü–∏–∏</li>
                    <li class="mb-2">‚ñ∂Ô∏è <strong>–ù–∞–∂–º–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å"</strong> –¥–ª—è –Ω–∞—á–∞–ª–∞</li>
                    <li class="mb-2">‚è∏Ô∏è <strong>–ò—Å–ø–æ–ª—å–∑—É–π "–ü–∞—É–∑–∞"</strong> –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏</li>
                    <li class="mb-2">üîÑ <strong>"–ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤"</strong> –¥–ª—è —Å–±—Ä–æ—Å–∞</li>
                </ul>

                <div class="mt-3">
                    <h6>–¶–≤–µ—Ç–∞:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge" style="background: #007bff;">–û–±—ã—á–Ω—ã–π</span>
                        <span class="badge" style="background: #ffc107; color: #000;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
                        <span class="badge" style="background: #dc3545;">–í—ã–±—Ä–∞–Ω–Ω—ã–π</span>
                        <span class="badge" style="background: #28a745;">–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sortvis.js' %}"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ ID –∞–ª–≥–æ—Ä–∏—Ç–º–∞
window.algorithmId = {{ algorithm.id }};

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    visualizer = new SortVisualizer('simulator-container', '{{ algorithm.name_en }}');

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤
    const initialSize = parseInt(document.getElementById('arraySize').value);
    visualizer.generateArray(initialSize);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('arraySize').addEventListener('input', function() {
        document.getElementById('arraySizeValue').textContent = this.value;
        if (!visualizer.isRunning) {
            visualizer.generateArray(parseInt(this.value));
        }
    });

    document.getElementById('speed').addEventListener('change', function() {
        visualizer.setSpeed(this.value);
    });

    document.getElementById('startBtn').addEventListener('click', async function() {
        if (visualizer.isRunning) return;

        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        document.getElementById('pauseBtn').disabled = false;

        await visualizer.start();

        this.disabled = false;
        this.innerHTML = '<i class="bi bi-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å';
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('pauseBtn').innerHTML = '<i class="bi bi-pause"></i> –ü–∞—É–∑–∞';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        showNotification('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
    });

    document.getElementById('pauseBtn').addEventListener('click', function() {
        visualizer.pause();
        if (visualizer.isPaused) {
            this.innerHTML = '<i class="bi bi-play"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            this.classList.remove('btn-warning');
            this.classList.add('btn-info');
        } else {
            this.innerHTML = '<i class="bi bi-pause"></i> –ü–∞—É–∑–∞';
            this.classList.remove('btn-info');
            this.classList.add('btn-warning');
        }
    });

    document.getElementById('resetBtn').addEventListener('click', function() {
        visualizer.reset();
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').innerHTML = '<i class="bi bi-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å';
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('pauseBtn').innerHTML = '<i class="bi bi-pause"></i> –ü–∞—É–∑–∞';
        document.getElementById('pauseBtn').classList.remove('btn-info');
        document.getElementById('pauseBtn').classList.add('btn-warning');
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
