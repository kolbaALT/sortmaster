{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-trophy"></i> {{ challenge.title }}</h3>
                    <span class="badge bg-{% if challenge.difficulty == 1 %}success{% elif challenge.difficulty == 2 %}warning{% elif challenge.difficulty == 3 %}orange{% else %}danger{% endif %} fs-6">
                        {{ challenge.get_difficulty_display }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <p class="lead">{{ challenge.description }}</p>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="bi bi-clock"></i> –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</h6>
                        <p>{% if challenge.time_limit %}{{ challenge.time_limit }} —Å–µ–∫—É–Ω–¥{% else %}–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π{% endif %}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-star"></i> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –æ—á–∫–∏</h6>
                        <p>{{ challenge.max_score }} –æ—á–∫–æ–≤</p>
                    </div>
                </div>

                <div class="mb-4">
                    <h6><i class="bi bi-list-check"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h6>
                    <div class="bg-light p-3 rounded">
                        {% for instruction in challenge.instructions.splitlines %}
                            <p class="mb-2">{{ instruction }}</p>
                        {% endfor %}
                    </div>
                </div>

                {% if user.is_authenticated %}
                    {% if challenge.challenge_type == 'speed_test' %}
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂:</h6>
                            <ol class="mb-0">
                                <li>–í—ã–±–µ—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ</li>
                                <li>–ó–∞–ø—É—Å—Ç–∏ —Å–∏–º—É–ª—è—Ü–∏—é –∏ –∑–∞—Å–µ–∫–∏ –≤—Ä–µ–º—è</li>
                                <li>–ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã</li>
                                <li>–ù–∞–∂–º–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂" –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ—à—å —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π</li>
                            </ol>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="row" id="algorithms-list">
                            <div class="col-12">
                                <h6>–í—ã–±–µ—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="testAlgorithm('Bubble Sort', 1)">
                                    ü´ß –ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="testAlgorithm('Selection Sort', 2)">
                                    üéØ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–æ–º
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="testAlgorithm('Insertion Sort', 3)">
                                    üìù –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—Å—Ç–∞–≤–∫–∞–º–∏
                                </button>
                            </div>
                        </div>

                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="mt-4" id="results-section" style="display: none;">
                            <h6>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>–ê–ª–≥–æ—Ä–∏—Ç–º</th>
                                            <th>–í—Ä–µ–º—è (–º—Å)</th>
                                            <th>–°—Ä–∞–≤–Ω–µ–Ω–∏—è</th>
                                            <th>–û–±–º–µ–Ω—ã</th>
                                        </tr>
                                    </thead>
                                    <tbody id="results-table">
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3">
                                <label for="fastest-algorithm" class="form-label">–ö–∞–∫–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –æ–∫–∞–∑–∞–ª—Å—è —Å–∞–º—ã–º –±—ã—Å—Ç—Ä—ã–º?</label>
                                <select class="form-select" id="fastest-algorithm">
                                    <option value="">–í—ã–±–µ—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º</option>
                                    <option value="Bubble Sort">–ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
                                    <option value="Selection Sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–æ–º</option>
                                    <option value="Insertion Sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—Å—Ç–∞–≤–∫–∞–º–∏</option>
                                </select>
                            </div>

                            <button class="btn btn-success mt-3" onclick="submitChallenge()">
                                <i class="bi bi-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
                            </button>
                        </div>

                    {% else %}
                        <div class="alert alert-info text-center">
                            <h5>üöß –≠—Ç–æ—Ç —Ç–∏–ø —á–µ–ª–ª–µ–Ω–¥–∂–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h5>
                            <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!</p>
                            <a href="{% url 'challenges:list' %}" class="btn btn-primary">
                                <i class="bi bi-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <h6>–í–æ–π–¥–∏ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —á–µ–ª–ª–µ–Ω–¥–∂–∞—Ö!</h6>
                        <a href="{% url 'account_login' %}" class="btn btn-primary">–í–æ–π—Ç–∏</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        {% if user.is_authenticated and user_attempts %}
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> –¢–≤–æ–∏ –ø–æ–ø—ã—Ç–∫–∏</h5>
            </div>
            <div class="card-body">
                {% for attempt in user_attempts|slice:":5" %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>–ü–æ–ø—ã—Ç–∫–∞ {{ attempt.attempts_count }}</span>
                    <span class="badge bg-{% if attempt.completed %}success{% else %}secondary{% endif %}">
                        {{ attempt.score }} –æ—á–∫–æ–≤
                    </span>
                </div>
                {% endfor %}

                {% if best_attempt %}
                <hr>
                <div class="text-center">
                    <h6 class="text-success">üèÜ –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h6>
                    <h4 class="text-primary">{{ best_attempt.score }} –æ—á–∫–æ–≤</h4>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∏</h5>
            </div>
            <div class="card-body">
                {% if challenge.challenge_type == 'speed_test' %}
                <ul class="list-unstyled">
                    <li class="mb-2">üí° –ü–æ–ø—Ä–æ–±—É–π —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –º–∞—Å—Å–∏–≤–æ–≤</li>
                    <li class="mb-2">‚è±Ô∏è –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</li>
                    <li class="mb-2">üìä –°—Ä–∞–≤–Ω–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π</li>
                    <li class="mb-2">üéØ –ü–æ–º–Ω–∏ –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤</li>
                </ul>
                {% else %}
                <p>–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –Ω–µ —Ç–æ—Ä–æ–ø–∏—Å—å!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ -->
<div class="modal fade" id="simulatorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <span id="current-algorithm"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-simulator-container"></div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="modal-arraySize" class="form-label">–†–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞: <span id="modal-arraySizeValue">20</span></label>
                        <input type="range" class="form-range" id="modal-arraySize" min="10" max="30" value="20">
                    </div>
                    <div class="col-md-6">
                        <label for="modal-speed" class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å</label>
                        <select class="form-select" id="modal-speed">
                            <option value="fast" selected>–ë—ã—Å—Ç—Ä–æ</option>
                            <option value="normal">–ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="slow">–ú–µ–¥–ª–µ–Ω–Ω–æ</option>
                        </select>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-success" id="modal-startBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    <button class="btn btn-secondary" id="modal-resetBtn">–°–±—Ä–æ—Å</button>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row mt-3 text-center">
                    <div class="col-3">
                        <h6 class="text-primary" id="modal-comparisons">0</h6>
                        <small>–°—Ä–∞–≤–Ω–µ–Ω–∏–π</small>
                    </div>
                    <div class="col-3">
                        <h6 class="text-success" id="modal-swaps">0</h6>
                        <small>–û–±–º–µ–Ω–æ–≤</small>
                    </div>
                    <div class="col-3">
                        <h6 class="text-warning" id="modal-steps">0</h6>
                        <small>–®–∞–≥–æ–≤</small>
                    </div>
                    <div class="col-3">
                        <h6 class="text-info" id="modal-time">0</h6>
                        <small>–í—Ä–µ–º—è (–º—Å)</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveTestResult()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sortvis.js' %}"></script>
<script>
let modalVisualizer = null;
let currentAlgorithmId = null;
let testResults = [];

function testAlgorithm(algorithmName, algorithmId) {
    currentAlgorithmId = algorithmId;
    document.getElementById('current-algorithm').textContent = algorithmName;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    modalVisualizer = new SortVisualizer('modal-simulator-container', algorithmName);
    modalVisualizer.generateArray(20);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('simulatorModal'));
    modal.show();

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    setupModalHandlers();
}

function setupModalHandlers() {
    document.getElementById('modal-arraySize').addEventListener('input', function() {
        document.getElementById('modal-arraySizeValue').textContent = this.value;
        if (modalVisualizer && !modalVisualizer.isRunning) {
            modalVisualizer.generateArray(parseInt(this.value));
        }
    });

    document.getElementById('modal-speed').addEventListener('change', function() {
        if (modalVisualizer) {
            modalVisualizer.setSpeed(this.value);
        }
    });

    document.getElementById('modal-startBtn').addEventListener('click', async function() {
        if (!modalVisualizer || modalVisualizer.isRunning) return;

        this.disabled = true;
        this.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';

        await modalVisualizer.start();

        this.disabled = false;
        this.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
    });

    document.getElementById('modal-resetBtn').addEventListener('click', function() {
        if (modalVisualizer) {
            modalVisualizer.reset();
        }
    });
}

function saveTestResult() {
    if (!modalVisualizer || !modalVisualizer.stats.startTime) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é!');
        return;
    }

    const result = {
        algorithm: document.getElementById('current-algorithm').textContent,
        time: modalVisualizer.stats.startTime ? Date.now() - modalVisualizer.stats.startTime : 0,
        comparisons: modalVisualizer.stats.comparisons,
        swaps: modalVisualizer.stats.swaps
    };

    testResults.push(result);
    updateResultsTable();

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    bootstrap.Modal.getInstance(document.getElementById('simulatorModal')).hide();
}

function updateResultsTable() {
    const tbody = document.getElementById('results-table');
    tbody.innerHTML = '';

    testResults.forEach(result => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${result.algorithm}</td>
            <td>${result.time}</td>
            <td>${result.comparisons}</td>
            <td>${result.swaps}</td>
        `;
    });

    document.getElementById('results-section').style.display = 'block';
}

async function submitChallenge() {
    const selectedAlgorithm = document.getElementById('fastest-algorithm').value;

    if (!selectedAlgorithm) {
        alert('–í—ã–±–µ—Ä–∏ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º!');
        return;
    }

    if (testResults.length < 2) {
        alert('–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π —Ö–æ—Ç—è –±—ã 2 –∞–ª–≥–æ—Ä–∏—Ç–º–∞!');
        return;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
    const fastestResult = testResults.reduce((min, current) =>
        current.time < min.time ? current : min
    );

    const isCorrect = selectedAlgorithm === fastestResult.algorithm;
    const score = isCorrect ? {{ challenge.max_score }} : Math.floor({{ challenge.max_score }} * 0.5);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    try {
        const response = await fetch('{% url "challenges:submit_challenge" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                challenge_id: {{ challenge.id }},
                score: score,
                completed: true,
                answer_data: {
                    selected_algorithm: selectedAlgorithm,
                    fastest_algorithm: fastestResult.algorithm,
                    test_results: testResults
                }
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`–ß–µ–ª–ª–µ–Ω–¥–∂ –∑–∞–≤–µ—Ä—à–µ–Ω! –¢—ã –ø–æ–ª—É—á–∏–ª ${score} –æ—á–∫–æ–≤!`);
            location.reload();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
    }
}
</script>
{% endblock %}
